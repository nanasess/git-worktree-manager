#!/bin/bash
#
# worktree - git worktree 一括管理ツール
#
# プロジェクトルート配下の複数 git リポジトリに対して
# worktree の作成・一覧・削除を一括で行う。
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"

# ライブラリ読み込み
source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/detect.sh"
source "$SCRIPT_DIR/lib/deps.sh"
source "$SCRIPT_DIR/lib/cmd_create.sh"
source "$SCRIPT_DIR/lib/cmd_list.sh"
source "$SCRIPT_DIR/lib/cmd_cleanup.sh"
source "$SCRIPT_DIR/lib/cmd_install.sh"

VERSION="0.1.0"

usage() {
    echo -e "${BOLD}worktree${NC} v${VERSION} - git worktree 一括管理ツール"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "    worktree <COMMAND> [OPTIONS]"
    echo ""
    echo -e "${BOLD}COMMANDS:${NC}"
    echo "    create <task-name>    タスク用の worktree を一括作成"
    echo "    list                  現在の worktree 一覧を表示"
    echo "    cleanup [task-name]   worktree を一括削除"
    echo "    install --skills      Claude Code skills をプロジェクトにインストール"
    echo ""
    echo -e "${BOLD}OPTIONS:${NC}"
    echo "    -h, --help            ヘルプを表示"
    echo "    -v, --version         バージョンを表示"
    echo ""
    echo "各コマンドのヘルプ: worktree <COMMAND> --help"
}

# メイン処理
main() {
    if [ $# -eq 0 ]; then
        usage
        exit 1
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            cmd_create "$@"
            ;;
        list|ls)
            cmd_list "$@"
            ;;
        cleanup|clean|rm)
            cmd_cleanup "$@"
            ;;
        install)
            cmd_install "$@"
            ;;
        -h|--help|help)
            usage
            exit 0
            ;;
        -v|--version|version)
            echo "worktree v${VERSION}"
            exit 0
            ;;
        *)
            log_error "不明なコマンド: $command"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"
